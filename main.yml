---
- name: Setup laptop environment
  hosts: localhost
  vars:
    home: "{{ lookup('env', 'HOME') }}"
    github:
    github_email: 10788630+andrea11@users.noreply.github.com
    public_name: andrea11
    private_name: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      64616363313761393264326534366266626139626266313238646132643362623331363535383865
      3437383139646239333134646537663539306661343661350a613431373736616139386364313664
      62393563343735616364626665363934386631303865636432313165336232346632633838303030
      3339633937633734340a633938363934366135313736356562383233326530623036306530323634
      3130
  roles:
    - role: andrea11.macos_setup.install_applications
      install_applications_formulae:
        - docker-compose
        - geckodriver
        - gnupg
        - jq
        - libfido2
        - nvm
        - openssh
        - pinentry-mac
        - pre-commit
        - pyenv
        - pyenv-virtualenv
        - protobuf
        - sdkman-cli
        - watch
        - wget
        - ykman
        - zoxide
      install_applications_casks:
        - 1password
        - 1password-cli
        - aws-vault
        - chromedriver
        - finicky
        - firefox
        - font-fira-code
        - hpedrorodrigues/tools/dockutil
        - hush
        - intellij-idea
        - microsoft-edge
        - orbstack
        - rectangle
        - spotify
        - visual-studio-code
        - warp
        - whatsapp
      install_applications_taps:
        - homebrew/cask-fonts
        - sdkman/tap
    - role: launch_applications_first_time
    - role: setup_java
      setup_java_java_major_versions:
        - 11
        - 17
      setup_java_certificate_websites:
        - url: artifactory.intra.nexthink.com
          port: 443
          alias: Nexthink Artifactory
    - role: setup_node
    - role: setup_python
    - role: setup_finicky
      setup_finicky_rules:
        - match: [/nexthink/]
          browser: Google Chrome
        - match: ({ opener }) => opener.name === "Microsoft Teams"
          browser: Google Chrome
        - match: ({ opener }) => opener.name === "Microsoft Outlook"
          browser: Google Chrome
        - match:
            ({ url }) => url.host === "device.sso.eu-central-1.amazonaws.com"
          browser: Google Chrome
        - match: () => finicky.getKeys().function
          browser: Google Chrome
    - role: setup_zsh
      setup_zsh_aliases:
        - alias: cd
          command: z
        - alias: npm
          command: pnpm
        - alias: ..
          command: cd ..
        - alias: "..."
          command: cd ../..
        - alias: "...."
          command: cd ../../..
      setup_zsh_use_oh_my_zsh: true
      setup_zsh_oh_my_zsh_plugins:
        - git
        - zoxide
      setup_zsh_use_sdkman: true
      setup_zsh_use_nvm: true
      setup_zsh_use_gpg: true
    - role: setup_ssh
      setup_ssh_configurations:
        - name: github_work
          allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
          user_email: "{{ github_email }}"
          signature:
            algorithm: ed25519
            private_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              39336233633763656266653239653239373633656530326632373366323736353363626363656437
              6235316336616662343230663764393138663638383362390a323036333362306563303335313364
              63386436646435623539303266326330393038333232656465383536353132393561353538623136
              6164333937323837380a383433663666623636656131663831623632396361656532383439656633
              30626236326562386564346239656535666265666334306666396335333666336362616135663839
              31383936643631316134346534373164303335663436396362636635366664626432343235663166
              63626638363839316364616639623765646534386438633864616438303563613539306561663531
              39393265616365393366373630316363353034373034336639396434623538343464373263626238
              38666338633833663437393933303835396231303031323261303865326138613830616635383164
              64623537633163343466393062323063336466356130653435313133383537313739623861313262
              34623434346531303662626561316535303165346638646531646431363437333138646533623636
              39343262393965626430353130383836313630666133393734363762313764616565373438346239
              34663137356262323963366663626137353166333238633538386264343032386665396632653438
              36333639386465383832653432653365303338663836313232343931633863663931366635613864
              31656362363937313230666430616238326539616530326465356137626163386666653133623362
              65663766656261356133313434656339613239623737616530663234343539376430656636323035
              66386638396131383432316163613136666263316337656164303762643066346331386535306331
              35643365653665313662353564626231386239626639343831366631323739616364386338633138
              62656534643565316266393630386334663934646236643036666431373731346436646165663763
              63373132663238643362306236656263393031346663636630613439616632376639663736653137
              66343264643131626433643432376461636264323065663333393562636564313532343831393465
              32363864663135386464656363623663363661613838656634333533663837376538376433363333
              66663135643761656161396437393735656566353936396662313837386636383438633636653264
              63613465623864653562333162303162663038646138343634656137393238393036613639373432
              31333435663932323532313539396132313735346265343061613731366463323438626263376265
              63633865393565306232336331626466613137613366313666313664653262343764303638396236
              36333161643863333066653365633637666131306331633437363034613062323732636466316561
              65366432306233343261366339346438373739393661626633393266636666333933356466613939
              39656237356264333032396337343865636239663039366662386431353066303130636239653439
              38363866613362393962373136353362313362353736316331663637653635343862343430646463
              37386466636434386134376465656263386330316139363665383332653661646534323037656636
              66623537316363383632343430363063333230336161316330636333363234643433383737373834
              62356130373939663834373138363832323463613831626335306331326365393532306636363862
              6438396562626339373937323262376238636364373866346431
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              63306438623334313738333563303962613162383066326435346363353932653161663235653265
              3164616634613565393135616239636366316233336237310a646330303565343336383939393734
              62633031353466343639633764303231646137373731653233336561343034303263636263313337
              6432653935653036310a373837636637336131613732333366633538626366666130306164323638
              34323535366565356163313130643138626265626362323532366561363163356163323062623363
              33363036616561383062663435663432333237316133333466656335643930353966363862356237
              30353362623731633461373232386632623936333433346264346131376263646232363862626162
              34363266646164643534623935643466393937363637343433373334383238396265383135323131
              61656666386434386238356265326530343264353166653862346264653266393233643666656632
              30316430663361393164636161656234353038656337666333383134633234313362643164643565
              66343162633836346436373130636633356562613838623939613836653362646462303739316431
              35316233363061393633383864316365623932353734313534393266316436346339663338303033
              3962
          authentication:
            algorithm: ed25519
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              35346364643735613938333363663362356630646165343538386261363265326665303664373461
              3065656666343032393362373133643232383730346561650a326537376537336631363639623161
              31656332663563323862613733616661636335366632653032666537656364306231386136303734
              3036343637326436390a373862396335643430646165336432366461313262323763666165373763
              34383836646338656661633935616439643534386331366235333363383132353361363165666566
              62386434613133326332323732643633633232633432386135663063383465386166303964633865
              66306130353830636639653866393438343639376662353734303965613166303034316139393639
              33613132643637616639353335333464373532643333383234643965643466636666656635323631
              6135
        - name: github_personal
          allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
          user_email: "{{ github_email }}"
          identity_agent:
            "{{ home }}/Library/Group
            Containers/2BUA8C4S2C.com.1password/t/agent.sock"
          signature:
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              36636630326633346335373361626232313866666535643239653562393961316436326132643530
              6236316232613565356530346531386664333961666234630a626132633361613239303065623263
              33363535663266376236303934643637363634306535633835316661313734383461323162646666
              3739396531323162390a383162626533363533333935363162643862366638343064666463656362
              38336530643462373134383536396636396564626234386263363866613235633166336266633235
              38646162306130636235666639366130613266623962613966653663616335656566623930353939
              38316231316638353731333864356639353230333666656639373961643034623666333333333235
              36346566303333346366326134323737333166363737346464333438656132316361613365306530
              3636
          authentication:
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              64386632666437343035613663316538316233353962636336636430303432346335383665653133
              6339316537333366633264323130643533306135353262380a653538633063633839643233386138
              61393037613064626631353935363032366365656635306633336130666134636163393731626435
              3737663336636139310a343434376238373730303534393939333434616266613635356265356231
              31623766626666356238666331626166373564303235336130326339393533393933333463656131
              30373035386633646462636536616236393732336566653839386365323762623936353364353761
              33616235623732656563653266623330373632356330346636616330363130353430363864303132
              37623537396566373937393837666336393464383866343334623234396466393965376563666437
              3864
    - role: setup_git
      setup_git_workspaces:
        - name: github_work
          path: "{{ home }}/Workspace"
          user_name: "{{ private_name }}"
          user_email: "{{ github_email }}"
          ssh:
            public_key_path: "{{ home }}/.ssh/github_work_signature_ed25519.pub"
            allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
        - name: github_personal
          path: "{{ home }}/Github"
          user_name: "{{ public_name }}"
          user_email: "{{ github_email }}"
          ssh:
            program: /Applications/1Password.app/Contents/MacOS/op-ssh-sign
            public_key_path:
              "{{ home }}/.ssh/github_personal_signature_ed25519.pub"
            allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
    - role: customize_dock
      customize_dock_dock_items:
        - name: Launchpad
          path: /System/Applications/Launchpad.app
          position: 1
        - name: Microsoft Outlook
          path: /Applications/Microsoft Outlook.app
          position: 2
        - name: Safari
          path: /System/Cryptexes/App/System/Applications/Safari.app
          position: 3
        - name: Google Chrome
          path: /Applications/Google Chrome.app
          position: 4
        - name: Microsoft Teams
          path: /Applications/Microsoft Teams.app
          position: 5
        - name: App Store
          path: /Applications/App Store.app
          position: 6
        - name: System Settings
          path: /System/Applications/System Settings.app
          position: 7
    - role: customize_defaults
      customize_defaults_settings:
        - domain: com.apple.AppleMultitouchTrackpad
          key: Clicking
          value: 1
          type: int
          state: present
        - domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
          key: Clicking
          value: 1
          type: int
          state: present
        - domain: com.apple.AppleMultitouchTrackpad
          key: TrackpadThreeFingerDrag
          value: true
          type: bool
          state: present
        - domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
          key: AppleMultitouchTrackpad
          value: true
          type: bool
          state: present
        - domain: com.apple.AppleMultitouchTrackpad
          key: TrackpadFourFingerVertSwipeGesture
          value: 2
          type: int
          state: present
        - domain: com.apple.dock
          key: showAppExposeGestureEnabled
          value: true
          type: bool
          state: present
        - domain: Apple Global Domain
          key: com.apple.trackpad.scaling
          value: 2
          type: float
          state: present
        - domain: dev.warp.Warp-Stable
          key: AliasExpansionBannerSeen
          value: "true"
          type: string
          state: present
        - domain: dev.warp.Warp-Stable
          key: AliasExpansionEnabled
          value: "true"
          type: string
          state: present
        - domain: dev.warp.Warp-Stable
          key: Theme
          value: '"RedRock"'
          type: string
          state: present
        - domain: com.knollsoft.Rectangle
          key: SUEnableAutomaticChecks
          value: true
          type: bool
          state: present
        - domain: com.knollsoft.Rectangle
          key: hideMenubarIcon
          value: true
          type: bool
          state: present
        - domain: com.knollsoft.Rectangle
          key: launchOnLogin
          value: true
          type: bool
          state: present
        # - domain: com.knollsoft.Rectangle
        #   key: bottomLeft
        #   value:
        #     - keyCode: "115"
        #       modifierFlags: "786432"
        #   type: array
        #   state: present
        # - domain: com.knollsoft.Rectangle
        #   key: bottomRight
        #   value:
        #     - keyCode: "119"
        #       modifierFlags: "786432"
        #   type: array
        #   state: present
        # - domain: com.knollsoft.Rectangle
        #   key: topLeft
        #   value:
        #     - keyCode: "123"
        #       modifierFlags: "917504"
        #   type: array
        #   state: present
        # - domain: com.knollsoft.Rectangle
        #   key: topRight
        #   value:
        #     - keyCode: "124"
        #       modifierFlags: "917504"
        #   type: array
        #   state: present
        - domain: dev.kdrag0n.MacVirt
          key: SUAutomaticallyUpdate
          value: true
          type: bool
          state: present
        - domain: dev.kdrag0n.MacVirt
          key: onboardingCompleted
          value: true
          type: bool
          state: present
        - domain: com.apple.HIToolbox
          key: AppleCurrentKeyboardLayoutInputSourceID
          value: com.apple.keylayout.USInternational-PC
          type: string
          state: present
        - domain: com.apple.LaunchServices
          key: LSQuarantine
          value: false
          type: bool
          state: present
        - domain: com.apple.BluetoothAudioAgent
          key: Apple Bitpool Min (editable)
          value: 40
          type: int
          state: present
        - domain: com.apple.finder
          key: AppleShowAllFiles
          value: true
          type: bool
          state: present
        - domain: NSGlobalDomain
          key: AppleShowAllExtensions
          value: true
          type: bool
          state: present
        - domain: com.apple.Safari
          key: HomePage
          value: about:blank
          type: string
          state: present
        - domain: com.apple.Safari
          key: ShowFavoritesBar
          value: false
          type: bool
          state: present
        - domain: com.apple.Safari
          key: FindOnPageMatchesWordStartsOnly
          value: false
          type: bool
          state: present
        - domain: com.apple.Safari
          key: IncludeInternalDebugMenu
          value: true
          type: bool
          state: present
        - domain: com.apple.Safari
          key: IncludeDevelopMenu
          value: true
          type: string
          state: present
        - domain: com.apple.Safari
          key: WebKitDeveloperExtrasEnabledPreferenceKey
          value: true
          type: bool
          state: present
        - domain: com.apple.Safari
          key: com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled # yamllint disable-line
          value: true
          type: bool
          state: present
        - domain: NSGlobalDomain
          key: WebKitDeveloperExtras
          value: true
          type: bool
          state: present
          # Keyboard - Set US international language
          # - domain: com.apple.HIToolbox
          #   key: AppleEnabledInputSources
          #   value:
          #     - InputSourceKind: "Keyboard Layout"
          #       KeyboardLayout ID: "15000"
          #       KeyboardLayout Name: "USInternational-PC"
          #   type: array
          #   state: present
          #   array_add: true
          # - domain: com.apple.HIToolbox
          #   key: AppleInputSourceHistory
          #   value:
          #     - InputSourceKind: "Keyboard Layout"
          #       KeyboardLayout ID: "15000"
          #       KeyboardLayout Name: "USInternational-PC"
          #   type: array
          #   state: present
          #   array_add: true
          # - domain: com.apple.HIToolbox
          #   key: AppleSelectedInputSources
          #   value:
          #     - InputSourceKind: "Keyboard Layout"
          #       KeyboardLayout ID: "15000"
          #       KeyboardLayout Name: "USInternational-PC"
          #   type: array
          #   state: present
          #   array_add: true
  post_tasks:
    - name: Reboot MacOs
      ansible.builtin.reboot:
