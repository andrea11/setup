---
- name: Setup laptop environment
  hosts: localhost
  vars:
    home: "{{ lookup('env', 'HOME') }}"
    github:
    github_email: 10788630+andrea11@users.noreply.github.com
    public_name: andrea11
    private_name: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      64616363313761393264326534366266626139626266313238646132643362623331363535383865
      3437383139646239333134646537663539306661343661350a613431373736616139386364313664
      62393563343735616364626665363934386631303865636432313165336232346632633838303030
      3339633937633734340a633938363934366135313736356562383233326530623036306530323634
      3130
  roles:
    - role: andrea11.macos_setup.install_applications
      install_applications_formulae:
        - docker-compose
        - geckodriver
        - gnupg
        - jq
        - libfido2
        - nvm
        - openssh
        - pinentry-mac
        - pre-commit
        - pyenv
        - pyenv-virtualenv
        - protobuf
        - sdkman-cli
        - watch
        - wget
        - ykman
        - zoxide
      install_applications_casks:
        - 1password
        - 1password-cli
        - aws-vault
        - chromedriver
        - finicky
        - firefox
        - font-fira-code
        - hpedrorodrigues/tools/dockutil
        - hush
        - intellij-idea
        - microsoft-edge
        - orbstack
        - rectangle
        - spotify
        - visual-studio-code
        - warp
        - whatsapp
      install_applications_taps:
        - homebrew/cask-fonts
        - sdkman/tap
    - role: launch_applications_first_time
    - role: setup_java
      setup_java_java_major_versions:
        - 11
        - 17
      setup_java_certificate_websites:
        - url: artifactory.intra.nexthink.com
          port: 443
          alias: Nexthink Artifactory
    - role: setup_node
    - role: setup_python
    - role: setup_finicky
      setup_finicky_rules:
        - match: [/nexthink/]
          browser: Google Chrome
        - match: ({ opener }) => opener.name === "Microsoft Teams"
          browser: Google Chrome
        - match: ({ opener }) => opener.name === "Microsoft Outlook"
          browser: Google Chrome
        - match:
            ({ url }) => url.host === "device.sso.eu-central-1.amazonaws.com"
          browser: Google Chrome
        - match: () => finicky.getKeys().function
          browser: Google Chrome
    - role: setup_zsh
      setup_zsh_aliases:
        - alias: cd
          command: z
        - alias: npm
          command: pnpm
        - alias: ..
          command: cd ..
        - alias: "..."
          command: cd ../..
        - alias: "...."
          command: cd ../../..
      setup_zsh_use_oh_my_zsh: true
      setup_zsh_oh_my_zsh_plugins:
        - git
        - zoxide
      setup_zsh_use_sdkman: true
      setup_zsh_use_nvm: true
      setup_zsh_use_gpg: true
    - role: setup_ssh
      setup_ssh_configurations:
        - name: github_work
          allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
          user_email: "{{ github_email }}"
          signature:
            algorithm: ed25519
            private_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              36366135623131306165363062636334633839336130346264633734653431333362323062356134
              3463656464333137623462333238336563373138663937320a393731636235616431396639383235
              35386530653434363538383261316434613333393836376564323866613639613934313132383337
              3836633063663938310a626464613330333262393866626137353339316431313963663665636362
              61386230623664663238396162653538613164386334336262643566613131313562306265356661
              66663837303035383062646466336632313636653664356531636435343630353662316564613838
              62653334303063383365373736333531343231313730363333396237333964303962313862656337
              34633834653932656465306538633439646465386462326364626632656434666337626261313364
              66343766383062333535623561633461643063353566666161343562646135326564663634363833
              33336462646436353031623638356463343235353163653933353864633461653761333835326237
              64366437376465316163366561636134306265333336336437623537663233643961323131646261
              33363830383137323530623161613934616431373161396362333139316439366362636231323433
              33303439393234383033313966643866393965616334353966303666323539303964323630396137
              62613338653365306465643136373339663835353133643632663532303730396163343436323966
              35363137656232363139636163616462336131353665306537393236326161353033376162386638
              36633734363537623732653937333931393062383062373437383038383464303639633366626136
              38306431343266336530643038353232626162633834336462636634303235363733393362393230
              38343134383563663235386239313065633937326365326231396331353161346165336361373966
              66383366653336343463313766383062373935353366633961633938626165653631396233333864
              31633961396338306232633137386335633532336261613765303831643464393131653331323461
              39646166333962316264623037323235366361643636323564383662313531633363613866383938
              31636335346235356437616130643664343232306536376361356430303937383138653165366661
              65313735353038633931366461643530366365616638313561346632663633333862653666633864
              35663961303230613037356562383035336462303037343636343764666662386562623036336434
              63343063396131306263313939343836333732356430373337623236343534336430623135323963
              65363863373835373537636439623066626434616437356162306637303565386131353661383033
              63643161613062353664336334656563396433613936636439656438373030633030343030386138
              36663438313630333839353339333263623337373562653665373266326666363638356432316432
              64326332313736613333306330663066626233663334363538353733396533633661336233316332
              66303333363965663166336536663934663165333739626365653434383063303638613639356266
              63653639363962613564336638326333393463646235643930313462306630366534616462386134
              63643864643932373837616631313739323737646263633865323165373166316261343331333031
              6331
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              33316338396562643636653738656537363935623262383134333638386163653761346539323232
              3165353439616232396361643433393532353863383832340a373132363963386337313533383137
              38633962373933353439303663376336353762653537363765623034383038393131353038636439
              6432656432643862620a363366623561313962656339633031653138356565313631323930653837
              32613464643133613833363032626163663666663563616433396337333163626435323433616464
              62653930376464643436366563656665366463646366383838383238333961366566373639353230
              30343635313639343563663166326437363132656366636330393239626132383232383661626234
              62363766353433306338623363623231616264326333663062343336306238336130383131363339
              31633138663762663063616539643636653036396366343339333438383531366538303364383838
              33636438316432306431613566363865626639316433613438353439363363613739623266323437
              356534643538653630313934343237306232
          authentication:
            algorithm: ed25519
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              35346364643735613938333363663362356630646165343538386261363265326665303664373461
              3065656666343032393362373133643232383730346561650a326537376537336631363639623161
              31656332663563323862613733616661636335366632653032666537656364306231386136303734
              3036343637326436390a373862396335643430646165336432366461313262323763666165373763
              34383836646338656661633935616439643534386331366235333363383132353361363165666566
              62386434613133326332323732643633633232633432386135663063383465386166303964633865
              66306130353830636639653866393438343639376662353734303965613166303034316139393639
              33613132643637616639353335333464373532643333383234643965643466636666656635323631
              6135
        - name: github_personal
          allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
          user_email: "{{ github_email }}"
          identity_agent:
            "{{ home }}/Library/Group
            Containers/2BUA8C4S2C.com.1password/t/agent.sock"
          signature:
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              36636630326633346335373361626232313866666535643239653562393961316436326132643530
              6236316232613565356530346531386664333961666234630a626132633361613239303065623263
              33363535663266376236303934643637363634306535633835316661313734383461323162646666
              3739396531323162390a383162626533363533333935363162643862366638343064666463656362
              38336530643462373134383536396636396564626234386263363866613235633166336266633235
              38646162306130636235666639366130613266623962613966653663616335656566623930353939
              38316231316638353731333864356639353230333666656639373961643034623666333333333235
              36346566303333346366326134323737333166363737346464333438656132316361613365306530
              3636
          authentication:
            public_key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              64386632666437343035613663316538316233353962636336636430303432346335383665653133
              6339316537333366633264323130643533306135353262380a653538633063633839643233386138
              61393037613064626631353935363032366365656635306633336130666134636163393731626435
              3737663336636139310a343434376238373730303534393939333434616266613635356265356231
              31623766626666356238666331626166373564303235336130326339393533393933333463656131
              30373035386633646462636536616236393732336566653839386365323762623936353364353761
              33616235623732656563653266623330373632356330346636616330363130353430363864303132
              37623537396566373937393837666336393464383866343334623234396466393965376563666437
              3864
    - role: setup_git
      setup_git_workspaces:
        - name: github_work
          path: "{{ home }}/Workspace"
          user_name: "{{ private_name }}"
          user_email: "{{ github_email }}"
          ssh:
            public_key_path: "{{ home }}/.ssh/github_work_signature_ed25519.pub"
            allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
        - name: github_personal
          path: "{{ home }}/Github"
          user_name: "{{ public_name }}"
          user_email: "{{ github_email }}"
          ssh:
            program: /Applications/1Password.app/Contents/MacOS/op-ssh-sign
            public_key_path:
              "{{ home }}/.ssh/github_personal_signature_ed25519.pub"
            allowed_signers_path: "{{ home }}/.ssh/allowed_signers"
    - role: customize_dock
      customize_dock_dock_items:
        - name: Launchpad
          path: /System/Applications/Launchpad.app
          position: 1
        - name: Microsoft Outlook
          path: /Applications/Microsoft Outlook.app
          position: 2
        - name: Safari
          path: /System/Cryptexes/App/System/Applications/Safari.app
          position: 3
        - name: Google Chrome
          path: /Applications/Google Chrome.app
          position: 4
        - name: Microsoft Teams
          path: /Applications/Microsoft Teams.app
          position: 5
        - name: App Store
          path: /Applications/App Store.app
          position: 6
        - name: System Settings
          path: /System/Applications/System Settings.app
          position: 7
    - role: customize_defaults
      customize_defaults_settings:
        - domain: com.apple.AppleMultitouchTrackpad
          key: Clicking
          value: 1
          type: int
          state: present
        - domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
          key: Clicking
          value: 1
          type: int
          state: present
        - domain: com.apple.AppleMultitouchTrackpad
          key: TrackpadThreeFingerDrag
          value: true
          type: bool
          state: present
        - domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
          key: AppleMultitouchTrackpad
          value: true
          type: bool
          state: present
        - domain: com.apple.AppleMultitouchTrackpad
          key: TrackpadFourFingerVertSwipeGesture
          value: 2
          type: int
          state: present
        - domain: com.apple.dock
          key: showAppExposeGestureEnabled
          value: true
          type: bool
          state: present
        - domain: Apple Global Domain
          key: com.apple.trackpad.scaling
          value: 2
          type: float
          state: present
        - domain: dev.warp.Warp-Stable
          key: AliasExpansionBannerSeen
          value: "true"
          type: string
          state: present
        - domain: dev.warp.Warp-Stable
          key: AliasExpansionEnabled
          value: "true"
          type: string
          state: present
        - domain: dev.warp.Warp-Stable
          key: Theme
          value: '"RedRock"'
          type: string
          state: present
        - domain: com.knollsoft.Rectangle
          key: SUEnableAutomaticChecks
          value: true
          type: bool
          state: present
        - domain: com.knollsoft.Rectangle
          key: hideMenubarIcon
          value: true
          type: bool
          state: present
        - domain: com.knollsoft.Rectangle
          key: launchOnLogin
          value: true
          type: bool
          state: present
        # - domain: com.knollsoft.Rectangle
        #   key: bottomLeft
        #   value:
        #     - keyCode: "115"
        #       modifierFlags: "786432"
        #   type: array
        #   state: present
        # - domain: com.knollsoft.Rectangle
        #   key: bottomRight
        #   value:
        #     - keyCode: "119"
        #       modifierFlags: "786432"
        #   type: array
        #   state: present
        # - domain: com.knollsoft.Rectangle
        #   key: topLeft
        #   value:
        #     - keyCode: "123"
        #       modifierFlags: "917504"
        #   type: array
        #   state: present
        # - domain: com.knollsoft.Rectangle
        #   key: topRight
        #   value:
        #     - keyCode: "124"
        #       modifierFlags: "917504"
        #   type: array
        #   state: present
        - domain: dev.kdrag0n.MacVirt
          key: SUAutomaticallyUpdate
          value: true
          type: bool
          state: present
        - domain: dev.kdrag0n.MacVirt
          key: onboardingCompleted
          value: true
          type: bool
          state: present
        - domain: com.apple.HIToolbox
          key: AppleCurrentKeyboardLayoutInputSourceID
          value: com.apple.keylayout.USInternational-PC
          type: string
          state: present
        - domain: com.apple.LaunchServices
          key: LSQuarantine
          value: false
          type: bool
          state: present
        - domain: com.apple.BluetoothAudioAgent
          key: Apple Bitpool Min (editable)
          value: 40
          type: int
          state: present
        - domain: com.apple.finder
          key: AppleShowAllFiles
          value: true
          type: bool
          state: present
        - domain: NSGlobalDomain
          key: AppleShowAllExtensions
          value: true
          type: bool
          state: present
        - domain: com.apple.Safari
          key: HomePage
          value: about:blank
          type: string
          state: present
        - domain: com.apple.Safari
          key: ShowFavoritesBar
          value: false
          type: bool
          state: present
        - domain: com.apple.Safari
          key: FindOnPageMatchesWordStartsOnly
          value: false
          type: bool
          state: present
        - domain: com.apple.Safari
          key: IncludeInternalDebugMenu
          value: true
          type: bool
          state: present
        - domain: com.apple.Safari
          key: IncludeDevelopMenu
          value: true
          type: string
          state: present
        - domain: com.apple.Safari
          key: WebKitDeveloperExtrasEnabledPreferenceKey
          value: true
          type: bool
          state: present
        - domain: com.apple.Safari
          key: com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled # yamllint disable-line
          value: true
          type: bool
          state: present
        - domain: NSGlobalDomain
          key: WebKitDeveloperExtras
          value: true
          type: bool
          state: present
          # Keyboard - Set US international language
          # - domain: com.apple.HIToolbox
          #   key: AppleEnabledInputSources
          #   value:
          #     - InputSourceKind: "Keyboard Layout"
          #       KeyboardLayout ID: "15000"
          #       KeyboardLayout Name: "USInternational-PC"
          #   type: array
          #   state: present
          #   array_add: true
          # - domain: com.apple.HIToolbox
          #   key: AppleInputSourceHistory
          #   value:
          #     - InputSourceKind: "Keyboard Layout"
          #       KeyboardLayout ID: "15000"
          #       KeyboardLayout Name: "USInternational-PC"
          #   type: array
          #   state: present
          #   array_add: true
          # - domain: com.apple.HIToolbox
          #   key: AppleSelectedInputSources
          #   value:
          #     - InputSourceKind: "Keyboard Layout"
          #       KeyboardLayout ID: "15000"
          #       KeyboardLayout Name: "USInternational-PC"
          #   type: array
          #   state: present
          #   array_add: true
  post_tasks:
    - name: Reboot MacOs
      ansible.builtin.reboot:
